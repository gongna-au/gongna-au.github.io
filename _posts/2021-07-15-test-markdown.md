---
layout: post
title:  What 's OK log?
subtitle: 一个用于大型集群的分布式且无协调的日志管理系统https://github.com/oklog/oklog
tags: [log, blog study]
---

# What 's OK log?

> 什么是好的日志管理系统？
>
> 一个用于大型集群的分布式且无协调的日志管理系统https://github.com/oklog/oklog

开源领域通常非常庞大和丰富。编排？选择：`Kubernetes`、`Nomad、DC/OS、ECS`——列表很长，而且大多数选项都不错。服务发现？`Consul`、`etcd`、`SmartStack`，甚至像 `Linkerd` 这样的解决方案都可以很好地工作。追踪？`OpenTracing` 是交换，`Zipkin`、`Appdash`、`Lightstep`、Tracer 等实现正在蓬勃发展。仪器仪表？普罗米修斯是`yyds`。记录？嗯，没有想到........

我扩大了搜索范围并[在 Twitter 上提问](https://twitter.com/peterbourgon/status/797256574242680832)。`Heka` 似乎很接近，但在前期遭遇了设计错误，最终转化为无法恢复的性能问题。现在已经被遗弃了。`Ekanite` 提供了端到端的解决方案，但 `syslog` 协议似乎与微服务工作负载明显不匹配。有很好的日志传送和注释工具，例如 `Fluentd` 和 `Logstash`。但他们只是解决了部分问题；他们不处理存储或查询。如果您的容量相对较低并且不介意将日志传送到云，则托管解决方案（例如 `Splunk` 和 `Loggly`）是一个不错的选择。但它们很快变得昂贵.

### 用于日志的Prometheus

用于日志的 Prometheus。那意味着什么？那么，普罗米修斯有什么好处呢？在我看来，

- 它是为自己运行而设计的：它既是开源的，也可以在本地部署
- 它专为“云原生”工作负载而设计：动态、容器化、微服务
- 它的设计易于操作：本地存储，无集群，拉模型
- 这是一个完整的系统：不需要单独的 TSDB、Web UI 等来获得可用的东西
- 它可以扩展和扩展：90% 的用户无需特别努力就感到满意

用于日志的 Prometheus 会是什么样子？

### 设计

##### 高水平目标

首先，像 Prometheus 一样，这样的系统应该是开源的并且可以在本地运行。最重要的是，它应该易于大规模部署和操作。它应该特别关注容器化的微服务工作负载。它应该是一个完整的端到端系统：转发器、摄取器、存储和查询方式。

主要用例是来自典型微服务的应用程序日志：想想调试、信息、警告等。这些通常是大容量、低 `QOS` 的日志，其中低延迟（查询时间）是首选。但是，我们还希望提供所谓的事件日志：审计跟踪、点击跟踪等。这些通常是低容量、高 `QOS` 的日志，可以接受更高的延迟。最后，它应该是一个通用的日志消费者，管理来自 `MySQL` 等黑盒系统的输出。也就是说，我们可能无法控制格式的日志。我相信同一个系统可以以合理的规模满足所有这些需求。

考虑到这些目标，我们可以开始添加约束，以使问题易于处理。

##### 约束问题

像这样的数据系统应该专注于可靠地传输数据，*或者*为该数据增加价值。也就是说，它应该是一个传输系统，解决更多的机械问题，与传输的数据无关；或者它应该是一个应用系统，提供业务价值，与拓扑和性能要求无关。试图用单一的解决方案解决这两个问题会产生相互竞争的紧张局势，并损害结果。所以更加偏向传输系统，解决较低级别的吞吐量和延迟问题。我们可以使用单独的工具在该系统之外添加应用程序或业务价值。例如，上下文注释可以在`grep`之前发生。或者，解析日志以构建聚合可以使用 `ETL` 完成，将视图具体化为具有更丰富查询功能的数据系统。

考虑到这一点，有时限的 `grep` 作为查询界面似乎完全可以接受。对于新用户，他们通常只想要一个熟悉的界面来帮助他们调试——“我只想 `grep` 我的日志！” - 它立即有用。

##### The importance of writes

![系统图](https://peter.bourgon.org/ok-log/diagram1.png)

### Ingestion（摄取）

![系统图](https://peter.bourgon.org/ok-log/diagram2.png)

### Replication（复制）

![系统图](https://peter.bourgon.org/ok-log/diagram3.png)

### 

