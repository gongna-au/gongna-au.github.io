---
layout: post
title: 云原生安全漏洞
subtitle:
tags: [云原生]
comments: true
---

> 攻防演练中的云原生安全：

在云原生环境中，我会按照以下步骤组织和执行一次攻防演练：

规划和目标设定：首先，明确演练的目的和范围，例如是否要测试某个特定的安全威胁或验证某个特定的安全控制措施。
团队分工：建立红队（攻击团队）和蓝队（防御团队）。红队负责模拟真实的攻击者，蓝队负责防御并检测攻击。
攻击模拟：红队使用工具和手段模拟各种攻击，例如针对Kubernetes API的攻击、容器逃逸、应用层攻击等。
防御和检测：蓝队使用监控、日志和其他安全工具来检测和防御红队的攻击。
结果分析：在演练结束后，整理和分析结果，识别存在的安全漏洞和不足。
总结和反馈：基于结果，提出改进建议，修复漏洞，并调整安全策略和控制措施。


> 单容器环境内的信息收集：

在单容器环境中，我会使用以下方法来收集运行时信息：

使用docker logs命令收集容器的日志信息。
使用docker inspect命令获取容器的详细配置信息和元数据。
使用docker stats命令收集容器的资源使用情况。

安全隐患包括：
如果容器内部的应用记录了敏感信息，例如密码或API密钥，那么这些信息可能会泄露。
攻击者可以利用收集到的容器配置信息和元数据进行进一步的攻击。


> 容器网络：

容器网络与传统网络的主要区别在于其动态性和隔离性。容器网络是为每个容器实例动态创建的，通常使用虚拟网络技术来确保每个容器都在其自己的网络命名空间中运行。

与容器网络相关的常见安全问题包括：

网络策略配置不当，导致容器间的不必要的通信。
容器暴露不应该暴露的端口。
对外部网络的访问未受到限制，可能导致数据泄露或被恶意利用。
网络通信未加密，导致数据在传输过程中被截获。

> 关于逃逸的那些事


什么是容器逃逸？它为何构成安全威胁？
容器逃逸是指攻击者从容器内部突破其隔离限制，获得对宿主机或其他容器的访问权限。这构成安全威胁，因为它可能允许攻击者获得对整个系统的控制，从而对其他容器和整个宿主机造成破坏。

解释privileged容器的风险，并描述如何通过mount device进行逃逸。
privileged容器具有与宿主机相同的权限，这意味着它可以执行许多正常情况下被限制的操作。通过mount device进行逃逸的方法是，在privileged容器中，攻击者可以挂载宿主机的文件系统或设备，从而访问宿主机上的数据或执行命令。

如何攻击lxcfs？
lxcfs是为容器提供虚拟文件系统视图的工具。攻击lxcfs通常涉及利用其内部的漏洞或错误配置，以获得对容器外部环境的访问权限。

如何通过创建cgroup进行容器逃逸？
通过创建或操纵cgroup，攻击者可能能够执行一些被容器限制的系统调用或操作。例如，他们可以调整资源限制或执行其他原本被禁止的操作。

描述Docker in Docker和攻击挂载了主机/proc目录的容器之间的关系。
Docker in Docker是在Docker容器内运行另一个Docker守护进程的配置。如果攻击者可以在这样的容器内执行命令，他们可能会访问宿主机上的/proc目录，从而获取系统信息或进行进一步的攻击。

SYS_PTRACE在容器环境中存在哪些安全风险？
SYS_PTRACE能力允许容器跟踪其他进程。在容器中，这可能允许攻击者监视其他容器的进程，或者利用ptrace相关的漏洞进行攻击。

描述如何利用Service Account权限过大进行攻击。
如果Service Account的权限设置得过大，攻击者可以利用这些权限执行他们不应该能够执行的操作，例如创建新的容器、访问敏感数据或修改集群配置。

如何利用CVE-2020-15257？
CVE-2020-15257是一个关于containerd的漏洞，攻击者可以通过该漏洞在容器内访问Unix套接字，从而可能进行进一步的攻击。

怎样的内核漏洞可能导致容器逃逸？
内核漏洞，特别是那些涉及系统调用、命名空间或cgroup的漏洞，可能允许攻击者突破容器的隔离界限，从而实现逃逸。例如，通过利用这些漏洞，攻击者可能能够执行原本被禁止的系统调用，或访问容器外部的资源。


> 容器相关组件的历史漏洞

CVE-2019-5736：这是一个与runc相关的漏洞，runc是多个容器平台（如Docker、Podman和其他）的底层组件。攻击者可以通过这个漏洞替换宿主机上的runc二进制文件，从而获得宿主机的root权限。

CVE-2018-1002105：这是一个Kubernetes API服务器的漏洞，允许攻击者通过API服务器的后门执行任意请求，绕过正常的认证和授权机制。

CVE-2020-8554：这是一个Kubernetes的服务代理（kube-proxy）相关的漏洞，攻击者可以利用这个漏洞进行端口转发攻击，对集群内的服务进行中间人攻击。

CVE-2020-15157：又被称为“ContainerDrip”，这个漏洞允许攻击者在containerd的镜像拉取过程中插入恶意内容。

CVE-2019-14271：这是Docker的一个漏洞，允许攻击者加载恶意Docker插件，然后执行任意代码。

CVE-2019-16884：这是runc的另一个漏洞，攻击者可以利用该漏洞提升权限并在宿主机上执行任意命令。

> 容器、容器编排组件API配置不当或未鉴权：

> 描述apiserver、kubelet、dashboard、etcd、docker remote api、kubectl proxy等组件的主要功能。这些组件在未正确配置或未鉴权时可能会导致哪些安全问题？

组件的主要功能：

apiserver：Kubernetes API服务器是Kubernetes控制面的前端，它的主要职责是验证和配置与资源对象的数据，例如Pods、Services等。

kubelet：kubelet是在Kubernetes节点上运行的主要代理，它确保容器在Pod中正常运行。

dashboard：Kubernetes Dashboard是一个基于Web的Kubernetes用户界面，允许用户管理和监控Kubernetes集群的各种资源。

etcd：etcd是用于共享配置和服务发现的一致性键值存储系统。Kubernetes使用etcd存储所有集群数据。

docker remote api：Docker Remote API允许用户通过HTTP接口与Docker守护进程通信，进行容器管理。

kubectl proxy：kubectl proxy命令为Kubernetes API Server创建一个代理，使用户可以轻松访问API Server。

安全问题：

apiserver：如果未正确配置，攻击者可能会绕过认证和授权机制，访问Kubernetes API，从而控制整个集群。

kubelet：kubelet的未授权访问可能允许攻击者执行命令或部署应用程序。

dashboard：历史上，Dashboard默认安装并启用了较高权限的Service Account。攻击者可以利用这一点，执行命令或窃取集群数据。

etcd：如果etcd暴露给外部且未加密，攻击者可以读取所有Kubernetes数据，或更改集群的状态。

docker remote api：如果Docker Remote API未鉴权且对外部开放，攻击者可以创建、删除或操作容器，这可能导致数据泄露或拒绝服务攻击。

kubectl proxy：如果公开访问，攻击者可以直接访问Kubernetes API，这可能导致数据泄露或更改集群状态。


容器镜像安全问题：

供应链攻击：容器镜像的“供应链”攻击是指在镜像构建、传输或部署的过程中插入恶意代码或依赖的攻击。例如，攻击者可能会篡改镜像构建过程中使用的基础镜像或第三方库，或者劫持镜像传输过程中的数据。

二次开发所产生的安全问题：

在对Kubernetes API进行请求转发或拼接时，可能会暴露敏感信息，导致API未授权访问，或者因为未正确验证输入而遭受注入攻击。

Serverless：

定义：Serverless是一种云计算执行模型，在该模型中，云提供商会动态分配机器资源来执行单个函数调用。这些函数通常用于响应事件，如HTTP请求、数据库更改或队列服务消息。

与容器的主要区别：容器是为长时间运行的应用程序设计的，并且它们通常包含一个完整的运行时环境。而Serverless函数是为短暂的、事件驱动的操作设计的，它们通常只包含执行特定任务所需的代码和依赖。

攻击公共容器/镜像：攻击者可能会寻找公共容器或镜像中的已知漏洞，或者发布包含恶意代码的镜像，等待其他用户使用。

APISIX的RCE利用：RCE（远程代码执行）是指允许攻击者在远程系统上执行任意代码的漏洞。关于APISIX的具体RCE利用方式，我需要更多的上下文，但一般来说，它可能涉及到发送恶意构造的请求来触发漏洞。

其他利用场景和手法：

从CronJob谈起，持久化攻击在Kubernetes环境中可以通过创建恶意的CronJobs来实现。例如，攻击者可以创建一个CronJob，每隔一段时间就执行恶意活动，如数据窃取、资源利用或进一步的攻击。这种方式可以确保即使攻击者的初始入侵点被消除，他们仍然可以在集群中保持活跃。

