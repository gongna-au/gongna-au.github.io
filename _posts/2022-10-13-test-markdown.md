---
layout: post

title: 什么是 分布式？
subtitle: 垂直伸缩和水平伸缩

tags: [分布式？]
---

## 1.分布式

### 访问系统的用户过多带来的服务器崩溃

> 当访问系统的用户越来越多，可是我们的系统资源有限，所以需要更多的 CPU 和内存去处理用户的计算请求，当然也就要求更大的网络带宽去处理数据的传输，也需要更多的磁盘空间存储数据。资源不够，消耗过度，服务器崩溃，系统也就不干活了，那么在这样的情况怎么处理？

### 垂直伸缩(雅迪变特斯拉)

> 提升单台服务器的计算处理能力来抵抗更大的请求访问量。比如使用更快频率的 CPU，更快的网卡，塞更多的磁盘等。其实这样的处理方式在电信，银行等企业比较常见，让摩托车变为小汽车，更强大的计算机。花钱买设备就完事了？

    单台服务器的计算处理能力是有限的，而且也会严重受到计算机硬件水平的制约

#### 水平伸缩（多个雅典抵的上特斯拉）

> 通过多台服务器构成(分布式集群)从而提升系统的整体处理能力。这里说到了分布式，那我们看看分布式的成长过程
> 系统的技术架构是需求所驱动
> 最初的单体系统：

- 只需要部分用户访问（随着使用系统的用户越来越多，这时候关注的人越来越多，单台服务器扛不住了，关注的人觉得响应真慢）
- 然后分离数据库和应用程序，部署在不同的服务器中，从 1 台服务器变为多台服务器，处理响应更快，内容也够干，（访问的用户呈指数增长，这多台服务器都有点扛不住了，怎么办？）
- 然后加缓存，我们不每次从数据库中读取数据，而将应用程序需要的数据暂存在缓冲中。缓存呢，又分为本地缓存和分布式的缓存。分布式缓存，顾名思义，使用多台服务器构成集群，存储更多的数据并提供缓存服务，从而提升缓存的能力。（很多台的服务器单单存储很多的数据到内存中）
- 系统越来越火，于是考虑将应用服务器也作为集群。

## 2.缓存（提升系统的读操作性能）

当用户访问网站时，他们首先会收到来自 DNS 服务器的响应，其中包含您的主机 Web 服务器的 IP 地址。然后他们的浏览器请求网页内容，这些内容通常由各种静态文件组成，例如 HTML 页面、CSS 样式表、JavaScript 代码和图像。
一旦推出 CDN 并将这些静态资产卸载到 CDN 服务器上，通过手动“推出”它们或让 CDN 自动“拉”资产（这两种机制都将在下一节中介绍），然后您可以指示您的 Web 服务器重写指向静态内容的链接，使这些链接现在指向由 CDN 托管的文件。如果您使用的是 WordPress 等 CMS，则可以使用 CDN Enabler 等第三方插件来实现此链接重写。

缓存机制因 CDN 提供商而异，但通常它们的工作方式如下：

当 CDN 收到对静态资产（例如 PNG 图像）的第一个请求时，它没有缓存资产，并且必须从附近的 CDN 边缘服务器或源服务器本身获取资产的副本。这称为缓存“未命中”.通常可以通过检查包含 X-Cache: MISS. 此初始请求将比未来请求慢，因为在完成此请求后，资产将被缓存在边缘。

路由到此边缘位置的此资产的未来请求（缓存“命中”）现在将从缓存中提供服务，直到到期（通常通过 HTTP 标头设置）。这些响应将比初始请求快得多，从而显着减少用户的延迟并将 Web 流量卸载到 CDN 网络上。您可以通过检查 HTTP 响应标头来验证响应是否来自 CDN 缓存，该标头现在应该包含 X-Cache: HIT.

### 1.通读缓存

- 应用程序和通读缓存沟通，如果通读缓存中没有需要的数据，是由通读缓存去数据源中获取数据。

  > 数据存在于通读缓存中就直接返回。如果不存在于通读缓存，那么就访问数据源，同时将数据存放于缓存中。下次访问就直接从缓存直接获取。比较常见的为 CDN 和反向代理
  > CDN 称为内容分发网络。想象我们京东购物的时候，假设我们在成都，如果买的东西在成都仓库有就直接给我们寄送过来，可能半天就到了，用户体验也非常好，就不用从北京再寄过来。同样的道理，用户就可以近距离获得自己需要的数据，既提高了响应速度，又节约了网络带宽和服务器资源
  > 通过 CDN 等通读缓存可以降低服务器的负载能力

### 2.旁路缓存

- 应用程序从旁路缓存中读，如果不存在自己需要的数据，那么应用程序就去数据源负责把没有的数据拿到然后存储在旁路缓存中。

  > 旁路缓存

- 缓存缺点
  - （过期失效）缓存知道自己返回的数据是正确的吗？（我缓存中的数据是从数据源中拿出的，但是缓存在返回数据的时候，数据源里面的数据是否被修改？数据源里面的数据被修改，那么我们相当于是返回了脏数据）
- 解决办法：
  - （失效通知）每次写入往缓存中间写入数据的时候，(记录写入数据的时间)（再设置一个固定的时间），每次读取数据的时候根据记录的这个数据的写入时间，判断数据是否过期，如果时间过期，缓存就重新从数据源里面读取数据。
  - 当数据源的数据被修改的时候就一定要通知缓存清空
- 缓存的意义？
  - 存储热点数据，并且存储的数据被多次命中。

## 3.异步架构（提升系统的写操作性能）

> 缓存通常很难保证数据的持久性和一致性.我们通常不会将数据直接写入缓存中，而是写入 RDBMAS 等数据中，那如何提升系统的写操作性能呢？
> 也就是说，数据库是专门用来做存储的。
> 此时假设两个系统分别为 A,B，其中 A 系统依赖 B 系统，两者通信采用远程调用的方式，此时如果 B 系统出故障，很可能引起 A 系统出故障.(缓存不能保证数据的持久且唯一)

### 1.消息队列

#### 同步

> 同步通常是当应用程序调用服务的时候，不得不阻塞等待服务期完成，此时 CPU 空闲比较浪费，直到返回服务结果后才会继续执行。

- 特点：（阻塞并等待结果）（执行应用程序的线程阻塞 )
- 问题：不能释放占用的系统资源，导致系统资源不足，影响系统性能
- 问题：无法快速给用户响应结果

> 那么什么情况下可以不用阻塞，释放占用的系统资源？

#### 异步

- **调用者将消息发送给消息队列直接返回** ，线程不需要得到发送结果，它只需要执行完就好。例如（用户注册）（在用户注册完毕，不论我们的服务器是否真的已经账号激活的邮件给用户，页面都会提示用户：“您的邮件已经发送成功！请注意查收”）往往只让用户等待接收邮件就好，而不是我们实际的代码等待我们的服务器真正发送给用户邮件的时候才给用户显示：“邮件已经发送成功”

- **有专门的“消费消息的程序”从消息队列中取出数据并进行消费。** 远程服务出现故障，只会影响到" 消费消息的程序"

##### 异步消费的方式

- 点对点
  > 对多生产者多消费者的情况：一个消息被一个消费者消费
- 订阅消费
  > 给消息队列设置主题。每个消费者只从对应的主题中消费，每个消费者按照自己的逻辑进行计算。在用户注册的时候，我们将注册信息放入“用户“主题中，消费者如果订阅了“用户“主题，就可以消费该信息进行自己的业务处理。举个例子：可能有"拿用户信息去构造短信消息的"消费者，也有“拿着用户信息去推广产品的“消费者，都可以根据自己业务逻辑进行数据处理。

##### 异步消费的优点

- 快速响应
  > 不在需要等待。生产者将数据发送消息队列后，可继续往下执行，不虚等待耗时的消费处理
- 削峰填谷
  > 互联网产品会在不同的场景其并发请求量不同。互联网应用的访问压力随时都在变化，系统的访问高峰和低谷的并发压力可能也有非常大的差距。如果按照压力最大的情况部署服务器集群，那么服务器在绝大部分时间内都处于闲置状态。但利用消息队列，我们可以将需要处理的消息放入消息队列，而消费者可以控制消费速度，因此能够降低系统访问高峰时压力，而在访问低谷的时候还可以继续消费消息队列中未处理的消息，保持系统的资源利用率
- 降低耦合

> 如果调用是同步，如果调用是同步的，那么意味着调用者和被调用者必然存在依赖，一方面是代码上的依赖，应用程序需要依赖发送邮件相关的代码，如果需要修改发送邮件的代码，就必须修改应用程序，而且如果要增加新的功能

那么目前主要的消息队列有哪些，其有缺点是什么？

- 解耦!!
  > 某个 A 系统与要提供数据系统产生耦合
- 异步!!
  > 用户一个点击，需要几个系统间的一系列反应，同时每一个系统肯都存在一定的耗时，那么可以使用 mq 对不同的系统进行发送命令，进行异步操作
- 削峰!!
  > （mysql 每秒 2000 个请求），超过就会卡死，峰取时在 MQ 中进行大量请求积压,处理器按照自己的最大处理能力取请求量，等请求期过后再把它消耗掉。
